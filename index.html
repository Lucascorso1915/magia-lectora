<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Magia Lectora ‚ú®</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{--gold:#f0c060;--gold-dark:#c8960a;--purple:#2d1b69;--purple-mid:#4a2d8a;--purple-light:#7c5cbf;--cream:#f5eed8;--dark:#0e0820;--silver:#c0c0d0;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Crimson Text',serif;background:var(--dark);color:var(--cream);min-height:100vh;overflow:hidden;}
#stars{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse at 20% 30%,#1a0840 0%,#0e0820 50%,#000510 100%);}
.star{position:absolute;background:white;border-radius:50%;animation:twinkle var(--d) ease-in-out infinite;}
@keyframes twinkle{0%,100%{opacity:0.2;transform:scale(1);}50%{opacity:1;transform:scale(1.3);}}
.particle{position:fixed;pointer-events:none;z-index:200;font-size:1.2rem;animation:float-up linear forwards;opacity:0;}
@keyframes float-up{0%{opacity:1;transform:translateY(0) rotate(0deg);}100%{opacity:0;transform:translateY(-160px) rotate(360deg);}}
#app{position:relative;z-index:10;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
header{text-align:center;padding:1rem 1rem 0.2rem;width:100%;}
.title-main{font-family:'Cinzel',serif;font-size:clamp(1.4rem,5vw,2.3rem);font-weight:900;color:var(--gold);text-shadow:0 0 30px rgba(240,192,96,0.6),0 2px 4px rgba(0,0,0,0.8);}
.title-sub{font-size:0.85rem;color:var(--silver);font-style:italic;}
.screen{display:none;width:100%;flex-direction:column;align-items:center;}
.screen.active{display:flex;}

/* HOME */
#home-screen{padding:0.7rem 1rem;gap:0.65rem;}
.section-title{font-family:'Cinzel',serif;font-size:0.8rem;color:var(--gold);text-align:center;letter-spacing:0.1em;text-transform:uppercase;}
.divider{width:60%;max-width:200px;height:1px;background:linear-gradient(90deg,transparent,var(--gold-dark),transparent);margin:0 auto;}

/* Speed slider */
.speed-wrap{display:flex;flex-direction:column;align-items:center;gap:0.5rem;width:100%;max-width:380px;padding:0 0.5rem;}
.speed-row{display:flex;align-items:center;gap:0.8rem;width:100%;}
.speed-lbl{font-size:0.75rem;color:var(--silver);white-space:nowrap;}
input[type=range]{flex:1;-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;background:linear-gradient(90deg,var(--gold-dark),var(--gold));outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:24px;height:24px;border-radius:50%;background:var(--gold);border:3px solid var(--dark);cursor:pointer;box-shadow:0 0 8px rgba(240,192,96,0.6);}
.speed-val{font-family:'Cinzel',serif;font-size:1.2rem;color:var(--gold);font-weight:700;min-width:4.5rem;text-align:center;}

/* Total */
.total-options{display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;}
.total-btn{padding:0.45rem 0.9rem;border:2px solid var(--purple-light);background:transparent;color:var(--cream);border-radius:30px;font-family:'Crimson Text',serif;font-size:0.95rem;cursor:pointer;transition:all 0.2s;}
.total-btn.selected,.total-btn:hover{background:var(--purple-light);border-color:var(--gold);color:var(--gold);}

.start-btn{background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:var(--dark);border:none;padding:0.85rem 2rem;border-radius:50px;font-family:'Cinzel',serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 20px rgba(240,192,96,0.4);letter-spacing:0.05em;}
.start-btn:hover{transform:scale(1.05);}
.reto-btn{background:linear-gradient(135deg,#6b0000,#a00020);color:var(--gold);border:2px solid var(--gold);padding:0.85rem 2rem;border-radius:50px;font-family:'Cinzel',serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 20px rgba(240,0,0,0.3);letter-spacing:0.05em;}
.reto-btn:hover{transform:scale(1.05);box-shadow:0 6px 30px rgba(240,0,0,0.5);}
.home-btns{display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:center;}
.btn-secondary{padding:0.6rem 1.3rem;border:2px solid var(--purple-light);background:transparent;color:var(--cream);border-radius:30px;font-family:'Crimson Text',serif;font-size:0.95rem;cursor:pointer;transition:all 0.2s;}
.btn-secondary:hover{background:var(--purple-light);}
.warning-banner{background:rgba(139,0,0,0.3);border:1px solid #ff6060;border-radius:10px;padding:0.6rem 1rem;font-size:0.8rem;color:#ffa0a0;text-align:center;max-width:420px;}

/* GAME */
#game-screen{padding:0.7rem;gap:0.5rem;}
.hud{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:500px;padding:0.45rem 1rem;background:rgba(255,255,255,0.05);border-radius:20px;border:1px solid rgba(240,192,96,0.2);}
.hud-item{text-align:center;}
.hud-label{font-size:0.6rem;color:var(--silver);text-transform:uppercase;letter-spacing:0.1em;}
.hud-value{font-family:'Cinzel',serif;font-size:1rem;color:var(--gold);font-weight:700;}
.hud-correct{color:#7cbb7c;}
.hud-wrong{color:#ff8080;}
.progress-bar-wrap{width:100%;max-width:500px;height:5px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold));border-radius:3px;transition:width 0.3s ease;}
.reto-bar-wrap{width:100%;max-width:500px;height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;}
.reto-bar{height:100%;background:linear-gradient(90deg,#a00020,#ff4060);border-radius:4px;transition:width 0.5s linear;}
.reto-timer-display{font-family:'Cinzel',serif;font-size:2rem;font-weight:900;color:#ff6080;text-shadow:0 0 20px rgba(255,60,80,0.5);text-align:center;}
.reto-timer-display.urgent{color:#ff2040;animation:urgent-pulse 0.5s ease-in-out infinite alternate;}
@keyframes urgent-pulse{from{text-shadow:0 0 10px rgba(255,32,64,0.5);}to{text-shadow:0 0 30px rgba(255,32,64,1);}}
.word-arena{width:100%;max-width:500px;min-height:130px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.instruction-text{font-size:0.82rem;color:var(--silver);font-style:italic;margin-bottom:0.3rem;text-align:center;min-height:1.3em;}
.word-display{font-family:'Cinzel',serif;font-size:clamp(2rem,9vw,4rem);font-weight:900;color:var(--gold);text-shadow:0 0 40px rgba(240,192,96,0.8);text-align:center;min-height:1.2em;display:flex;align-items:center;justify-content:center;letter-spacing:0.04em;transition:opacity 0.15s;}
.word-display.hidden{opacity:0;pointer-events:none;}
.timer-ring-wrap{position:relative;}
.timer-ring{transform:rotate(-90deg);}
.timer-ring circle.bg{fill:none;stroke:rgba(255,255,255,0.1);stroke-width:4;}
.timer-ring circle.prog{fill:none;stroke:var(--gold);stroke-width:4;stroke-dasharray:157;stroke-dashoffset:0;stroke-linecap:round;transition:stroke 0.3s;}
.timer-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Cinzel',serif;font-size:0.85rem;font-weight:700;color:var(--cream);}
#voice-area{display:flex;flex-direction:column;align-items:center;gap:0.6rem;width:100%;max-width:500px;}
.mic-btn{width:80px;height:80px;border-radius:50%;background:radial-gradient(circle,#4a2d8a,#2d1b69);border:3px solid var(--gold);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:2.2rem;transition:all 0.2s;box-shadow:0 0 20px rgba(240,192,96,0.3);}
.mic-btn.listening{border-color:#ff6060;animation:pulse-mic 1s ease-out infinite;}
@keyframes pulse-mic{0%{box-shadow:0 0 0 0 rgba(255,96,96,0.6);}70%{box-shadow:0 0 0 20px rgba(255,96,96,0);}100%{box-shadow:0 0 0 0 rgba(255,96,96,0);}}
.mic-status{font-size:0.85rem;color:var(--silver);font-style:italic;text-align:center;min-height:1.3em;}
.transcript-display{font-family:'Cinzel',serif;font-size:1.3rem;color:var(--cream);min-height:1.8em;text-align:center;}
.feedback-overlay{position:fixed;inset:0;z-index:150;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;font-family:'Cinzel',serif;font-size:clamp(3rem,15vw,7rem);font-weight:900;}
.feedback-overlay.show-correct{animation:fb-ok 0.7s ease forwards;color:#b0ffb0;text-shadow:0 0 60px #7cbb7c;}
.feedback-overlay.show-wrong{animation:fb-bad 0.7s ease forwards;color:#ffa0a0;text-shadow:0 0 60px #ff6060;}
@keyframes fb-ok{0%{opacity:0;transform:scale(0.5);}40%{opacity:1;transform:scale(1.1);}70%{opacity:1;}100%{opacity:0;transform:scale(1);}}
@keyframes fb-bad{0%{opacity:0;transform:scale(0.5);}40%{opacity:1;transform:scale(1.1);}70%{opacity:1;}100%{opacity:0;transform:scale(1);}}
.stop-btn{padding:0.45rem 1.1rem;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.04);color:var(--silver);border-radius:30px;font-family:'Crimson Text',serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;margin-top:0.2rem;}
.stop-btn:hover{background:rgba(255,0,0,0.15);border-color:#ff6060;color:#ffa0a0;}

/* RESULTS */
#results-screen{padding:1rem;gap:0.7rem;align-items:center;}
.trophy{font-size:4rem;animation:bounce 1s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0);}to{transform:translateY(-12px);}}
.result-title{font-family:'Cinzel',serif;font-size:clamp(1.2rem,4.5vw,1.8rem);color:var(--gold);text-align:center;}
.stats-simple{display:flex;gap:1.2rem;justify-content:center;}
.stat-card{background:rgba(255,255,255,0.05);border:1px solid rgba(240,192,96,0.2);border-radius:12px;padding:0.7rem 1.4rem;text-align:center;}
.stat-num{font-family:'Cinzel',serif;font-size:2.2rem;font-weight:700;}
.stat-num.green{color:#7cbb7c;}
.stat-num.red{color:#ff8080;}
.stat-lbl{font-size:0.72rem;color:var(--silver);margin-top:0.1rem;}
.words-review{width:100%;max-width:420px;background:rgba(255,255,255,0.04);border:1px solid rgba(240,192,96,0.15);border-radius:12px;padding:0.7rem;max-height:110px;overflow-y:auto;}
.words-review-title{font-family:'Cinzel',serif;font-size:0.78rem;color:var(--gold);margin-bottom:0.3rem;}
.word-chip{display:inline-block;margin:2px;padding:0.15rem 0.5rem;border-radius:20px;font-size:0.85rem;}
.word-chip.ok{background:rgba(26,92,26,0.5);color:#b0ffb0;}
.word-chip.fail{background:rgba(139,0,0,0.5);color:#ffa0a0;}
.action-btns{display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:center;}

/* HISTORIAL */
#historial-screen{padding:1rem;gap:0.7rem;align-items:center;overflow-y:auto;max-height:100vh;}
.historial-title{font-family:'Cinzel',serif;font-size:1.5rem;color:var(--gold);text-align:center;}
.record-banner{background:linear-gradient(135deg,rgba(240,192,96,0.15),rgba(200,150,10,0.1));border:1px solid var(--gold);border-radius:14px;padding:0.7rem 1.2rem;text-align:center;width:100%;max-width:420px;}
.record-label{font-size:0.72rem;color:var(--silver);text-transform:uppercase;letter-spacing:0.1em;}
.record-value{font-family:'Cinzel',serif;font-size:2rem;color:var(--gold);font-weight:900;}
.historial-list{width:100%;max-width:420px;display:flex;flex-direction:column;gap:0.4rem;max-height:55vh;overflow-y:auto;}
.historial-entry{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.04);border:1px solid rgba(240,192,96,0.12);border-radius:10px;padding:0.55rem 0.8rem;}
.historial-entry.is-record{border-color:var(--gold);background:rgba(240,192,96,0.08);}
.entry-left{display:flex;flex-direction:column;}
.entry-date{font-size:0.72rem;color:var(--silver);}
.entry-speed{font-size:0.78rem;color:var(--purple-light);}
.entry-score{font-family:'Cinzel',serif;font-size:1.4rem;color:var(--gold);font-weight:700;}
.entry-crown{font-size:1rem;margin-left:0.3rem;}
.empty-historial{color:var(--silver);font-style:italic;text-align:center;padding:2rem;}
</style>
</head>
<body>
<div id="stars"></div>
<div class="feedback-overlay" id="feedback-overlay"></div>
<div id="app">
  <header>
    <div class="title-main">‚ú® Magia Lectora</div>
    <div class="title-sub">El sortilegio de las palabras</div>
  </header>

  <!-- HOME -->
  <div class="screen active" id="home-screen">
    <div class="divider" style="margin-top:0.3rem;"></div>
    <div id="voice-warning" class="warning-banner" style="display:none;">‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz. Usa Chrome en Android u ordenador.</div>

    <div class="section-title">Velocidad de aparici√≥n</div>
    <div class="speed-wrap">
      <div class="speed-row">
        <span class="speed-lbl">üî• R√°pido</span>
        <input type="range" id="speed-slider" min="1" max="19" step="1" value="1"
               oninput="onSliderChange(this.value)">
        <span class="speed-lbl">üê¢ Lento</span>
      </div>
      <div class="speed-val" id="speed-display">1 seg</div>
    </div>

    <div class="divider"></div>
    <div class="section-title">Palabras por sesi√≥n</div>
    <div class="total-options">
      <button class="total-btn" data-total="10" onclick="selectTotal(this)">10</button>
      <button class="total-btn selected" data-total="20" onclick="selectTotal(this)">20</button>
      <button class="total-btn" data-total="30" onclick="selectTotal(this)">30</button>
      <button class="total-btn" data-total="50" onclick="selectTotal(this)">50</button>
      <button class="total-btn" data-total="0" onclick="selectTotal(this)">‚àû Sin l√≠mite</button>
    </div>

    <div class="home-btns">
      <button class="start-btn" onclick="startGame(false)">ü™Ñ ¬°Empezar!</button>
      <button class="reto-btn" onclick="startGame(true)">‚öîÔ∏è ¬°Reto 2 min!</button>
    </div>
    <button class="btn-secondary" onclick="showHistorial()" style="margin-top:0.2rem;">üìú Ver historial de retos</button>
    <div style="height:0.5rem;"></div>
  </div>

  <!-- GAME -->
  <div class="screen" id="game-screen">
    <div class="hud">
      <div class="hud-item">
        <div class="hud-label">‚úÖ Correctas</div>
        <div class="hud-value hud-correct" id="hud-correct">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label" id="hud-center-label">Palabras</div>
        <div class="hud-value" id="hud-count">0/20</div>
      </div>
      <div class="hud-item">
        <div class="hud-label">‚ùå Falladas</div>
        <div class="hud-value hud-wrong" id="hud-wrong">0</div>
      </div>
    </div>

    <div class="progress-bar-wrap" id="normal-progress-wrap">
      <div class="progress-bar" id="progress-bar" style="width:0%"></div>
    </div>
    <div class="reto-bar-wrap" id="reto-progress-wrap" style="display:none;">
      <div class="reto-bar" id="reto-bar" style="width:100%"></div>
    </div>

    <div class="word-arena">
      <div class="reto-timer-display" id="reto-timer-display" style="display:none;">2:00</div>
      <div class="instruction-text" id="instruction-text">Memoriza la palabra...</div>
      <div class="word-display" id="word-display"></div>
      <div class="timer-ring-wrap" id="timer-ring-wrap" style="display:none;">
        <svg class="timer-ring" width="52" height="52" viewBox="0 0 52 52">
          <circle class="bg" cx="26" cy="26" r="23"/>
          <circle class="prog" id="timer-circle" cx="26" cy="26" r="23"/>
        </svg>
        <div class="timer-text" id="timer-text"></div>
      </div>
    </div>

    <div id="voice-area" style="display:none;">
      <div class="mic-status" id="mic-status">Pulsa el micr√≥fono y di la palabra</div>
      <button class="mic-btn" id="mic-btn" onclick="startListening()">üéôÔ∏è</button>
      <div class="transcript-display" id="transcript-display"></div>
    </div>

    <button class="stop-btn" onclick="confirmStop()">‚èπ Parar y salir</button>
  </div>

  <!-- RESULTS -->
  <div class="screen" id="results-screen">
    <div class="trophy" id="trophy-emoji">üèÜ</div>
    <div class="result-title" id="result-title">¬°Sortilegio completado!</div>

    <div id="reto-result-banner" style="display:none;width:100%;max-width:420px;background:linear-gradient(135deg,rgba(160,0,32,0.3),rgba(255,64,96,0.1));border:1px solid #ff4060;border-radius:14px;padding:0.8rem;text-align:center;">
      <div style="font-size:0.72rem;color:var(--silver);text-transform:uppercase;letter-spacing:0.1em;">Palabras correctas en 2 minutos</div>
      <div style="font-family:'Cinzel',serif;font-size:2.5rem;color:#ff6080;font-weight:900;" id="reto-final-count">0</div>
      <div style="font-size:0.8rem;color:var(--silver);" id="reto-record-msg"></div>
    </div>

    <div class="stats-simple" id="normal-stats">
      <div class="stat-card">
        <div class="stat-num green" id="r-correct">0</div>
        <div class="stat-lbl">‚úÖ Correctas</div>
      </div>
      <div class="stat-card">
        <div class="stat-num red" id="r-wrong">0</div>
        <div class="stat-lbl">‚ùå Falladas</div>
      </div>
    </div>

    <div class="words-review" id="words-review"></div>
    <div class="action-btns">
      <button class="start-btn" id="play-again-btn" onclick="startGame(false)">ü™Ñ Jugar de nuevo</button>
      <button class="reto-btn" id="reto-again-btn" style="display:none;" onclick="startGame(true)">‚öîÔ∏è Repetir reto</button>
      <button class="btn-secondary" onclick="showScreen('home-screen')">üè† Inicio</button>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="screen" id="historial-screen">
    <div class="historial-title">üìú Historial de Retos</div>
    <div class="record-banner" id="record-banner" style="display:none;">
      <div class="record-label">üèÜ R√©cord personal</div>
      <div class="record-value" id="record-value">0 palabras</div>
      <div style="font-size:0.75rem;color:var(--silver);" id="record-date"></div>
    </div>
    <div class="historial-list" id="historial-list"></div>
    <div class="action-btns" style="margin-top:0.5rem;">
      <button class="reto-btn" onclick="startGame(true)">‚öîÔ∏è ¬°Nuevo reto!</button>
      <button class="btn-secondary" onclick="showScreen('home-screen')">üè† Inicio</button>
    </div>
    <div style="height:0.8rem;"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ WORD BANK: 500 palabras 3+ s√≠labas, tem√°tica 5¬∫ primaria Espa√±a ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WORD_BANK = [
  "mariposa","elefante","girasol","cocodrilo","camale√≥n","rinoceronte","salamandra","murci√©lago","tortuga","hormiguero","canguro","ping√ºino","delfines","serpiente","leopardo","armadillo","tibur√≥n","cangrejo","escarabajo","lib√©lula","tormenta","rel√°mpago","arco√≠ris","terremoto","ecosistema","fotos√≠ntesis","vertebrado","invertebrado","mam√≠fero","nutrici√≥n","digesti√≥n","circulaci√≥n","respiraci√≥n","esqueleto","planeta","atm√≥sfera","temperatura","carn√≠voro","herb√≠voro","omn√≠voro","reproducci√≥n","evoluci√≥n","extinci√≥n","migraci√≥n","hibernaci√≥n","depredador","polinizaci√≥n","germinaci√≥n","metamorfosis","respiratorio",
  "continente","territorio","poblaci√≥n","parlamento","monumento","revoluci√≥n","constituci√≥n","econom√≠a","agricultura","industria","comercio","transporte","sociedad","cultura","tradici√≥n","patrimonio","geograf√≠a","democracia","civilizaci√≥n","monta√±oso","acantilado","pen√≠nsula","archipi√©lago","mediterr√°neo","atl√°ntico","cordillera","desembocadura","municipio","autonom√≠a","gobernador","embajador","colonizaci√≥n","feudalismo","renacimiento","ilustraci√≥n","prehistoria","paleol√≠tico","neol√≠tico","civilizado","monarqu√≠a",
  "sustantivo","adjetivo","pronombre","conjugar","sin√≥nimo","ant√≥nimo","met√°fora","narraci√≥n","personaje","argumento","p√°rrafo","di√°logo","poes√≠a","escritura","ortograf√≠a","gram√°tica","vocabulario","diccionario","descripci√≥n","comparaci√≥n","reflexionar","literatura","onomatopeya","hip√©rbole","aliteraci√≥n","personificaci√≥n","protagonista","antagonista","desenlace","introducci√≥n","conclusi√≥n","redacci√≥n","composici√≥n","puntuaci√≥n","acentuaci√≥n","may√∫scula","subordinada","coordinada","par√©ntesis","semicol√≥n",
  "multiplicar","dividir","fracci√≥n","porcentaje","per√≠metro","di√°metro","tri√°ngulo","rect√°ngulo","circunferencia","volumen","paralelo","perpendicular","diagonal","trapecio","pol√≠gono","romboide","is√≥sceles","equil√°tero","escaleno","cuadril√°tero","pent√°gono","hex√°gono","oct√≥gono","hect√°rea","kil√≥metro","cent√≠metro","mil√≠metro","mililitro","numerador","denominador","decimal","cociente","dividendo","divisor","multiplicador","resultado","operaci√≥n","ecuaci√≥n","potencia","radicando",
  "electricidad","magnetismo","gravitaci√≥n","evaporaci√≥n","condensaci√≥n","precipitaci√≥n","contaminaci√≥n","oxidaci√≥n","microscopio","term√≥metro","bar√≥metro","densidad","viscosidad","conductividad","transparente","transl√∫cido","opacidad","refracci√≥n","reflexi√≥n","absorci√≥n","mineralog√≠a","gravitatorio","fotograma","fotos√≠ntesis","energ√©tico","atmosf√©rico","biol√≥gico","qu√≠mico","f√≠sico","molecular",
  "acomodarse","acompa√±ado","acontecimiento","acostumbrado","acumulaci√≥n","administrar","adolescente","aficionado","afortunado","agradecimiento","aislamiento","amabilidad","amenazante","analizar","apasionado","arrepentirse","asombroso","atreverse","atrevimiento","aventurero","avergonzado","bibliograf√≠a","caligraf√≠a","calificaci√≥n","capacidad","caracter√≠stica","carbohidrato","certificado","cient√≠fico","clasificaci√≥n","colaboraci√≥n","colecci√≥n","combinaci√≥n","comentario","competencia","comprensi√≥n","comunicaci√≥n","concentraci√≥n","confianza","conocimiento","consecuencia","construcci√≥n","contenido","continuaci√≥n","conversaci√≥n","curiosidad","declaraci√≥n","dedicaci√≥n","definici√≥n","demostraci√≥n","dependencia","disciplina","disposici√≥n","distancia","diversi√≥n","documentaci√≥n","emocionante","enfermedad","equivocaci√≥n","estimulante","evaluaci√≥n","exageraci√≥n","excelencia","excursi√≥n","exhibici√≥n","experiencia","explicaci√≥n","exploraci√≥n","exposici√≥n","extraordinario","felicidad","festividad","funcionamiento","graduaci√≥n","habilidades","habitaci√≥n","herramienta","honestidad","humanidad","identidad","imaginaci√≥n","importancia","impresionante","independencia","informaci√≥n","ingrediente","inspiraci√≥n","instalaci√≥n","instrucci√≥n","inteligente","interpretaci√≥n","investigaci√≥n","liberaci√≥n","localizaci√≥n","manifestaci√≥n","maravilloso","memorizaci√≥n","meteorolog√≠a","motivaci√≥n","naturaleza","necesario","negociaci√≥n","observaci√≥n","organizaci√≥n","orientaci√≥n","participaci√≥n","perseverancia","planeaci√≥n","posibilidad","predicci√≥n","preparaci√≥n","presentaci√≥n","preservaci√≥n","producci√≥n","profesional","pronunciaci√≥n","protecci√≥n","publicaci√≥n","realizaci√≥n","recuperaci√≥n","reflexi√≥n","responsable","satisfacci√≥n","sensaci√≥n","separaci√≥n","soluci√≥n","terminaci√≥n","transformaci√≥n","utilizaci√≥n","valoraci√≥n","verificaci√≥n","voluntad","observatorio","laboratorio","ministerio","biblioteca","universidad","acad√©mico","colectividad","responsabilidad","simultaneidad","biodiversidad","contempor√°neo","contradicci√≥n","desafortunado","desequilibrio","espectacular","generosamente","habitualmente","imprescindible","inadecuado","incomprensible","interminable","irresponsable","misteriosamente","objetivamente","pr√°cticamente","progresivamente","razonablemente","relativamente","sorprendente","tranquilamente","filos√≥fico","tecnol√≥gico","matem√°tico","hist√≥rico","pol√≠tico","econ√≥mico","cultural","art√≠stico","cient√≠fico","democr√°tico","geogr√°fico","territorial","poblacional","industrial","comercial","agr√≠cola","transporte","legislativo","ejecutivo","judicial","derechos","deberes","ciudadan√≠a","solidaridad","cooperaci√≥n","convivencia","diversidad","tolerancia","pacifismo","diplom√°tico","colonia","independencia","terciario","secundario","primario","quaternario","mediterr√°neo","oce√°nico","continental","tropical","subtropical","ecuatorial","polar","templado","des√©rtico","alpino",
  "primeramente","seguidamente","finalmente","anteriormente","posteriormente","frecuentemente","normalmente","generalmente","habitualmente","especialmente","principalmente","absolutamente","completamente","profundamente","verdaderamente","simplemente","directamente","claramente","f√°cilmente","dif√≠cilmente","perfectamente","exactamente","probablemente","posiblemente","naturalmente","r√°pidamente","lentamente","suavemente","tranquilamente","silenciosamente","cuidadosamente","amablemente","brillantemente","correctamente","eficientemente","gratuitamente","inmediatamente","aproximadamente","definitivamente","independientemente","extraordinariamente"
];

// ‚îÄ‚îÄ Slider: posici√≥n 1 (izquierda) = m√°s r√°pido = 0.1seg
//           posici√≥n 19 (derecha) = m√°s lento = 1seg
// f√≥rmula: seg = 0.05 + (p-1)*0.05 = p * 0.05
// p=1 ‚Üí 0.05*1 = 0.05... pero queremos p=1‚Üí1seg, p=19‚Üí0.1seg
// Invertido: seg = 1.05 - p*0.05
// p=1 ‚Üí 1.05-0.05 = 1.00 seg ‚úì
// p=19 ‚Üí 1.05-0.95 = 0.10 seg ‚úì
function sliderToMs(p) {
  const secs = 1.05 - parseInt(p) * 0.05;
  return Math.round(secs * 1000);
}
function sliderToLabel(p) {
  const secs = 1.05 - parseInt(p) * 0.05;
  const fixed = secs.toFixed(2);
  // Mostrar sin ceros innecesarios: 1.00 ‚Üí "1 seg", 0.95 ‚Üí "0.95 seg"
  const clean = parseFloat(fixed);
  return clean + ' seg';
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RETO_DURATION = 120;
let state = {
  speed: 1000, total: 20, isReto: false, isInfinite: false,
  words: [], wordPool: [], poolIndex: 0,
  current: 0, correct: 0, wrong: 0, results: [],
  rafId: null, stopped: false,
  retoSecondsLeft: RETO_DURATION, retoInterval: null, retoStartTime: null,
};

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onSliderChange(p) {
  state.speed = sliderToMs(p);
  document.getElementById('speed-display').textContent = sliderToLabel(p);
}
onSliderChange(1); // default: 1 seg

function selectTotal(btn) {
  document.querySelectorAll('.total-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  state.total = parseInt(btn.dataset.total);
  state.isInfinite = (state.total === 0);
}

// ‚îÄ‚îÄ Word helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shuffle(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
function buildPool() { return shuffle([...WORD_BANK]); }
function getCurrentWord() {
  if (state.isReto || state.isInfinite) {
    if (state.poolIndex >= state.wordPool.length) { state.wordPool = buildPool(); state.poolIndex = 0; }
    return state.wordPool[state.poolIndex];
  }
  return state.words[state.current];
}

// ‚îÄ‚îÄ Historial ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STORAGE_KEY = 'magia-lectora-v4';
function loadHistorial() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } }
function saveHistorial(h) { localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }
function addHistorialEntry(correct, speedLabel) {
  const h = loadHistorial();
  const now = new Date();
  h.unshift({
    date: now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
    time: now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
    correct, speed: speedLabel, ts: now.getTime()
  });
  if (h.length > 50) h.pop();
  saveHistorial(h); return h;
}
function getRecord(h) { return h.length > 0 ? Math.max(...h.map(e => e.correct)) : 0; }

// ‚îÄ‚îÄ Speech ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recognition = null, recogActive = false;
function initSpeech() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { document.getElementById('voice-warning').style.display = 'block'; return; }
  recognition = new SR();
  recognition.lang = 'es-ES'; recognition.continuous = false; recognition.interimResults = true; recognition.maxAlternatives = 5;
  recognition.onstart = () => { recogActive = true; document.getElementById('mic-btn').classList.add('listening'); document.getElementById('mic-status').textContent = 'üî¥ Escuchando...'; };
  recognition.onend = () => { recogActive = false; document.getElementById('mic-btn').classList.remove('listening'); document.getElementById('mic-status').textContent = 'Pulsa el micr√≥fono y di la palabra'; };
  recognition.onerror = (e) => { recogActive = false; document.getElementById('mic-btn').classList.remove('listening'); if (e.error === 'no-speech') document.getElementById('mic-status').textContent = 'No te escuch√©. ¬°Int√©ntalo de nuevo!'; };
  recognition.onresult = (e) => {
    if (state.stopped) return;
    const target = getCurrentWord();
    let finalT = '', interimT = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        for (let j = 0; j < e.results[i].length; j++) { const alt = e.results[i][j].transcript.trim(); if (voiceMatch(alt, target)) { finalT = alt; break; } }
        if (!finalT) finalT = e.results[i][0].transcript.trim();
      } else { interimT += e.results[i][0].transcript.trim(); }
    }
    if (interimT) document.getElementById('transcript-display').textContent = interimT;
    if (finalT) { document.getElementById('transcript-display').textContent = finalT; recognition.stop(); evaluateVoice(finalT); }
  };
}
function normalize(s) { return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z]/g, ''); }
function levenshtein(a, b) { const m = a.length, n = b.length, dp = Array.from({ length: m + 1 }, (_, i) => Array.from({ length: n + 1 }, (_, j) => i === 0 ? j : j === 0 ? i : 0)); for (let i = 1; i <= m; i++) for (let j = 1; j <= n; j++) dp[i][j] = a[i - 1] === b[j - 1] ? dp[i - 1][j - 1] : 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]); return dp[m][n]; }
function voiceMatch(spoken, target) { const s = normalize(spoken), t = normalize(target); if (s === t) return true; if (s.includes(t) || t.includes(s)) return true; const mx = t.length <= 6 ? 1 : t.length <= 9 ? 2 : 3; return levenshtein(s, t) <= mx; }

// ‚îÄ‚îÄ Stars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createStars() { const c = document.getElementById('stars'); for (let i = 0; i < 100; i++) { const s = document.createElement('div'); s.className = 'star'; const sz = Math.random() * 2.5 + 0.5; s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random() * 100}%;top:${Math.random() * 100}%;--d:${2 + Math.random() * 4}s;animation-delay:${Math.random() * 4}s;`; c.appendChild(s); } }
createStars();

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function spawnParticles(emoji, count) { for (let i = 0; i < count; i++) setTimeout(() => { const p = document.createElement('div'); p.className = 'particle'; p.textContent = emoji; p.style.left = (20 + Math.random() * 60) + '%'; p.style.top = (20 + Math.random() * 50) + '%'; p.style.animationDuration = (0.8 + Math.random() * 0.7) + 's'; document.body.appendChild(p); setTimeout(() => p.remove(), 1500); }, i * 100); }
function showFeedback(ok) { const el = document.getElementById('feedback-overlay'); el.className = 'feedback-overlay'; el.textContent = ok ? '‚úì' : '‚úó'; void el.offsetWidth; el.classList.add(ok ? 'show-correct' : 'show-wrong'); setTimeout(() => { el.className = 'feedback-overlay'; el.textContent = ''; }, 700); }

// ‚îÄ‚îÄ Stop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmStop() {
  if (confirm('¬øSeguro que quieres parar y salir?')) {
    state.stopped = true;
    cancelAnimationFrame(state.rafId);
    stopRetoCountdown();
    if (recognition && recogActive) recognition.stop();
    showScreen('home-screen');
  }
}

// ‚îÄ‚îÄ Reto countdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startRetoCountdown() {
  state.retoSecondsLeft = RETO_DURATION; state.retoStartTime = Date.now();
  updateRetoTimer();
  state.retoInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - state.retoStartTime) / 1000);
    state.retoSecondsLeft = Math.max(0, RETO_DURATION - elapsed);
    updateRetoTimer();
    if (state.retoSecondsLeft <= 0) { clearInterval(state.retoInterval); endGame(); }
  }, 500);
}
function updateRetoTimer() {
  const s = state.retoSecondsLeft, m = Math.floor(s / 60), sec = s % 60;
  const disp = document.getElementById('reto-timer-display');
  disp.textContent = `${m}:${sec.toString().padStart(2, '0')}`;
  disp.classList.toggle('urgent', s <= 15);
  document.getElementById('reto-bar').style.width = (s / RETO_DURATION * 100) + '%';
  document.getElementById('hud-count').textContent = state.correct;
}
function stopRetoCountdown() { clearInterval(state.retoInterval); }

// ‚îÄ‚îÄ Game flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame(isReto) {
  state.isReto = isReto; state.stopped = false;
  state.correct = 0; state.wrong = 0; state.results = []; state.current = 0; state.poolIndex = 0;
  state.wordPool = buildPool();
  if (!isReto && !state.isInfinite) {
    state.words = state.wordPool.slice(0, state.total);
  }

  if (isReto) {
    document.getElementById('normal-progress-wrap').style.display = 'none';
    document.getElementById('reto-progress-wrap').style.display = 'block';
    document.getElementById('reto-timer-display').style.display = 'block';
    document.getElementById('hud-center-label').textContent = '‚öîÔ∏è RETO';
    document.getElementById('hud-count').textContent = '0';
  } else {
    document.getElementById('normal-progress-wrap').style.display = 'block';
    document.getElementById('reto-progress-wrap').style.display = 'none';
    document.getElementById('reto-timer-display').style.display = 'none';
    document.getElementById('hud-center-label').textContent = state.isInfinite ? '‚àû Palabras' : 'Palabras';
    document.getElementById('hud-count').textContent = state.isInfinite ? '0' : `0/${state.total}`;
    document.getElementById('progress-bar').style.width = '0%';
  }
  document.getElementById('hud-correct').textContent = '0';
  document.getElementById('hud-wrong').textContent = '0';

  showScreen('game-screen');
  if (isReto) startRetoCountdown();
  nextWord();
}

function updateHUD() {
  document.getElementById('hud-correct').textContent = state.correct;
  document.getElementById('hud-wrong').textContent = state.wrong;
  if (!state.isReto) {
    if (state.isInfinite) {
      document.getElementById('hud-count').textContent = state.current;
    } else {
      document.getElementById('hud-count').textContent = `${state.current}/${state.total}`;
      document.getElementById('progress-bar').style.width = (state.current / state.total * 100) + '%';
    }
  }
}

function nextWord() {
  if (state.stopped) return;
  if (!state.isReto && !state.isInfinite && state.current >= state.total) { endGame(); return; }
  cancelAnimationFrame(state.rafId);
  document.getElementById('voice-area').style.display = 'none';
  const wd = document.getElementById('word-display');
  wd.className = 'word-display'; wd.textContent = getCurrentWord(); wd.style.color = '';
  document.getElementById('instruction-text').textContent = 'Memoriza la palabra...';
  startTimerDisplay(state.speed, () => { wd.classList.add('hidden'); showAnswerPhase(); });
}

function startTimerDisplay(dur, cb) {
  const circle = document.getElementById('timer-circle');
  const tt = document.getElementById('timer-text');
  const wrap = document.getElementById('timer-ring-wrap');

  if (dur >= 400) {
    wrap.style.display = 'block';
    circle.style.strokeDashoffset = 0;
    const C = 144;
    const start = Date.now();
    function tick() {
      if (state.stopped) { wrap.style.display = 'none'; return; }
      const e = Date.now() - start, p = Math.min(e / dur, 1);
      circle.style.strokeDashoffset = C * p;
      circle.style.stroke = `hsl(${60 - p * 60},90%,60%)`;
      const sLeft = (dur - e) / 1000;
      tt.textContent = sLeft > 0.05 ? sLeft.toFixed(1) : '';
      if (p < 1) { state.rafId = requestAnimationFrame(tick); }
      else { wrap.style.display = 'none'; cb(); }
    }
    state.rafId = requestAnimationFrame(tick);
  } else {
    wrap.style.display = 'none';
    const t = setTimeout(() => { if (!state.stopped) cb(); }, dur);
    state.rafId = t; // store so we can cancel if needed
  }
}

function showAnswerPhase() {
  if (state.stopped) return;
  document.getElementById('instruction-text').textContent = '¬øCu√°l era? Di la palabra en voz alta üéôÔ∏è';
  document.getElementById('voice-area').style.display = 'flex';
  document.getElementById('transcript-display').textContent = '';
  document.getElementById('mic-status').textContent = 'Pulsa el micr√≥fono y di la palabra';
  document.getElementById('mic-btn').classList.remove('listening');
}

function startListening() {
  if (!recognition) return;
  if (recogActive) { recognition.stop(); return; }
  document.getElementById('transcript-display').textContent = '';
  try { recognition.start(); } catch (e) { }
}

function evaluateVoice(spoken) {
  if (state.stopped) return;
  const word = getCurrentWord();
  const ok = voiceMatch(spoken, word);
  const wd = document.getElementById('word-display');
  wd.textContent = word; wd.className = 'word-display'; wd.style.color = ok ? '#b0ffb0' : '#ffa0a0';
  if (ok) { doCorrect(); }
  else { document.getElementById('mic-status').textContent = `Dijiste "${spoken}" ‚Äî Era: ${word}`; doWrong(); }
  setTimeout(() => {
    wd.style.color = ''; document.getElementById('voice-area').style.display = 'none'; advanceWord();
  }, 1000);
}

function doCorrect() {
  state.correct++;
  state.results.push({ word: getCurrentWord(), ok: true });
  showFeedback(true);
  if (state.correct % 5 === 0) spawnParticles('‚≠ê', 4);
}
function doWrong() {
  state.wrong++;
  state.results.push({ word: getCurrentWord(), ok: false });
  showFeedback(false);
}

function advanceWord() {
  if (state.stopped) return;
  if (state.isReto || state.isInfinite) { state.poolIndex++; }
  else { state.current++; }
  updateHUD();
  nextWord();
}

// ‚îÄ‚îÄ End game ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function endGame() {
  cancelAnimationFrame(state.rafId);
  stopRetoCountdown();
  if (recognition && recogActive) recognition.stop();

  const sliderVal = document.getElementById('speed-slider').value;
  const speedLabel = sliderToLabel(sliderVal);

  if (state.isReto) {
    const h = addHistorialEntry(state.correct, speedLabel);
    const record = getRecord(h);
    const isNewRecord = h.length > 1 && h[0].correct >= record;
    document.getElementById('reto-result-banner').style.display = 'block';
    document.getElementById('normal-stats').style.display = 'none';
    document.getElementById('reto-final-count').textContent = state.correct;
    document.getElementById('reto-record-msg').textContent = isNewRecord ? 'üèÜ ¬°Nuevo r√©cord personal!' : `R√©cord: ${record} palabras`;
    document.getElementById('play-again-btn').style.display = 'none';
    document.getElementById('reto-again-btn').style.display = 'inline-block';
    let trophy = 'ü•â', title = '¬°Reto completado!';
    if (state.correct >= 25) { trophy = 'üèÜ'; title = '¬°Eres una lectora m√°gica!'; }
    else if (state.correct >= 15) { trophy = 'ü•á'; title = '¬°Sortilegio exitoso!'; }
    else if (state.correct >= 8) { trophy = 'ü•à'; title = '¬°Vas mejorando!'; }
    document.getElementById('trophy-emoji').textContent = trophy;
    document.getElementById('result-title').textContent = title;
    if (isNewRecord) spawnParticles('üèÜ', 8);
  } else {
    document.getElementById('reto-result-banner').style.display = 'none';
    document.getElementById('normal-stats').style.display = 'flex';
    document.getElementById('r-correct').textContent = state.correct;
    document.getElementById('r-wrong').textContent = state.wrong;
    document.getElementById('play-again-btn').style.display = 'inline-block';
    document.getElementById('reto-again-btn').style.display = 'none';
    const total = state.correct + state.wrong;
    const acc = total > 0 ? Math.round((state.correct / total) * 100) : 0;
    let trophy = 'ü•â', title = '¬°Buen intento!';
    if (acc >= 90) { trophy = 'üèÜ'; title = '¬°Maestra de la Magia!'; }
    else if (acc >= 70) { trophy = 'ü•á'; title = '¬°Sortilegio exitoso!'; }
    else if (acc >= 50) { trophy = 'ü•à'; title = '¬°Vas mejorando!'; }
    document.getElementById('trophy-emoji').textContent = trophy;
    document.getElementById('result-title').textContent = title;
  }

  const review = document.getElementById('words-review');
  review.innerHTML = '<div class="words-review-title">üìñ Palabras practicadas:</div>';
  state.results.slice(0, 40).forEach(r => {
    const chip = document.createElement('span');
    chip.className = 'word-chip ' + (r.ok ? 'ok' : 'fail');
    chip.textContent = r.word;
    review.appendChild(chip);
  });

  showScreen('results-screen');
  spawnParticles('‚≠ê', 10);
}

// ‚îÄ‚îÄ Historial screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showHistorial() {
  const h = loadHistorial();
  const record = getRecord(h);
  const rb = document.getElementById('record-banner');
  if (h.length > 0) {
    rb.style.display = 'block';
    document.getElementById('record-value').textContent = record + ' palabras';
    const best = h.find(e => e.correct === record);
    document.getElementById('record-date').textContent = best ? `${best.date} a las ${best.time}` : '';
  } else { rb.style.display = 'none'; }
  const list = document.getElementById('historial-list');
  list.innerHTML = '';
  if (h.length === 0) {
    list.innerHTML = '<div class="empty-historial">Todav√≠a no hay retos completados.<br>¬°Atr√©vete con el primero!</div>';
  } else {
    h.forEach(e => {
      const isRec = e.correct === record;
      const div = document.createElement('div');
      div.className = 'historial-entry' + (isRec ? ' is-record' : '');
      div.innerHTML = `
        <div class="entry-left">
          <div class="entry-date">${e.date} ¬∑ ${e.time}</div>
          <div class="entry-speed">‚ö° ${e.speed || '‚Äî'}</div>
        </div>
        <div style="display:flex;align-items:center;">
          <div class="entry-score">${e.correct}</div>
          ${isRec ? '<div class="entry-crown">üëë</div>' : ''}
        </div>`;
      list.appendChild(div);
    });
  }
  showScreen('historial-screen');
}

initSpeech();
</script>
</body>
</html>
